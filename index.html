<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>負數加減｜數線練功房</title>
<meta name="theme-color" content="#7c5cff">
<style>
  :root{
    --bg:#fff8fb;
    --card:#ffffff;
    --primary:#7c5cff;     /* 正確路徑（右移） */
    --accent:#ff82b1;      /* 正確路徑（左移） */
    --ink:#222;
    --muted:#7a7a7a;
    --good:#17b26a;
    --bad:#ef4444;
    --chip:#f7f7ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: linear-gradient(180deg,var(--bg),#f8fbff);
    color:var(--ink);
    -webkit-tap-highlight-color: transparent;
  }
  /* utility */
  .hidden{display:none !important}
  /* Compact mobile header */
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 10px; position:sticky; top:0; backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.88); border-bottom:1px solid #eee; z-index:10;
  }
  .brand{display:flex; align-items:center; gap:8px; min-width:0}
  .brand .logo{
    width:26px; height:26px; border-radius:8px; display:grid; place-items:center;
    background: radial-gradient(circle at 30% 30%, #ffd9e8, #d9e4ff);
    box-shadow: 0 6px 16px rgba(124,92,255,0.25) inset;
    font-size:14px;
  }
  .brand h1{font-size:14px; line-height:1; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .toolbar{display:flex; gap:6px; align-items:center;}
  button, .btn{
    cursor:pointer; border:none; padding:10px 14px; border-radius:12px; font-weight:700;
    background:var(--primary); color:white; box-shadow:0 6px 16px rgba(124,92,255,0.25);
    transition: transform .06s ease;
  }
  button.ghost{background:#f2f2ff; color:#4b4bb5; box-shadow:none}
  button.flat{background:#efefef; color:#333; box-shadow:none}
  button:active{transform: translateY(1px)}
  /* Mobile-first layout */
  .layout{
    display:grid; grid-template-columns: 1fr; gap:10px; padding:10px; max-width:720px; margin:0 auto;
  }
  .card{
    background:var(--card); border:1px solid #eee; border-radius:14px; padding:12px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.04);
  }
  .mode-tabs{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; justify-content:center}
  .mode-tabs button{background:#ffeefe; color:#7b3a6a; padding:8px 10px; border-radius:10px}
  .mode-tabs button.active{background:var(--accent); color:#fff}
  .scorebar{
    display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-bottom:6px;
  }
  .chip{
    background:var(--chip); border:1px dashed #d7d7ff; border-radius:10px; padding:6px; text-align:center;
    font-weight:800; color:#4b4bb5; font-size:13px;
    position:relative;
  }
  .score-fly{
    position:absolute; left:50%; top:-2px; transform:translate(-50%,0);
    font-size:12px; font-weight:900; opacity:0; pointer-events:none;
    transition: transform .6s ease, opacity .6s ease;
  }
  .score-fly.show{opacity:1; transform:translate(-50%,-18px);}
  .big-op{
    font-size: clamp(18px, 4.5vw, 22px);
    display:flex; align-items:center; justify-content:center; gap:8px; margin:4px 0 8px; flex-wrap:wrap;
  }
  .big-op .bubble{
    background:#fff4f9; border:2px solid #ffd6ea; color:#c84580; font-weight:900;
    padding:6px 10px; border-radius:10px;
  }
  .answer-pack{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; justify-content:center; }
  .answer-pack input[type="text"]{
    width:120px; padding:10px; border-radius:12px; border:1px solid #ddd; font-size:20px; font-weight:800; text-align:center;
    background:#fff;
  }
  .mini-keys{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center}
  .mini-keys .k{background:#f2f2ff; color:#4b4bb5; padding:8px 10px; border-radius:10px; font-weight:800; border:1px solid #d7d7ff}
  .controls{display:flex; gap:6px; justify-content:center; flex-wrap:wrap; margin-top:6px}
  .controls button{min-width:92px}
  .numline-wrap{
    background: #fff9fb;
    border:1px dashed #ffd0e6; border-radius:14px; padding:8px; margin:8px 0 6px;
  }
  svg{width:100%; height:auto;}
  .result-msg{min-height:24px; font-weight:900; text-align:center; margin-top:4px}
  .ok{color:var(--good)} .ng{color:var(--bad)}
  .tiny{font-size:12px; color:#666; text-align:center}
  .side{display:grid; gap:10px}
  @media (min-width: 900px){
    .layout{grid-template-columns: 1fr 320px; max-width:1100px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">➕</div>
    <h1>負數加減｜數線練功房</h1>
  </div>
  <div class="toolbar">
    <button id="btnSettings" class="ghost" aria-label="設定">⚙️</button>
  </div>
</header>

<div class="layout">
  <main class="card">
    <div class="mode-tabs">
      <button data-mode="practice" class="active">🌱 練習（有數線）</button>
      <button data-mode="review">🧩 錯題複習</button>
      <button data-mode="exam">🎯 測驗（無數線）</button>
    </div>

    <div class="scorebar">
      <div class="chip">⭐ 分數 <span id="score">0</span><span id="scoreFly" class="score-fly">+0</span></div>
      <div class="chip">🔥 連擊 <span id="streak">0</span></div>
      <div class="chip">🎓 熟練度 <span id="mastery">0%</span></div>
      <div class="chip">🏆 最高分 <span id="best">0</span></div>
    </div>

    <div class="big-op">
      <div class="bubble" id="opA">-3</div>
      <div class="bubble" id="opSign">-</div>
      <div class="bubble" id="opB">2</div>
      <div class="bubble">=</div>
      <div class="answer-pack">
        <input id="answer" type="text" inputmode="decimal" pattern="-?[0-9]*" placeholder="輸入整數…" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        <div class="mini-keys">
          <button class="k" id="btnMinus" type="button">−</button>
          <button class="k" id="btnClear" type="button">清除</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="btnSubmit" type="button">送出</button>
      <button id="btnNext" class="ghost" type="button">下一題 ▶</button>
      <button id="btnSkip" class="flat" type="button">略過</button>
    </div>

    <div class="numline-wrap">
      <svg id="numline" viewBox="0 0 800 150" preserveAspectRatio="xMidYMid meet" role="img" aria-label="數線"></svg>
      <div class="tiny">
        練習/複習：顯示正確步驟；測驗：送出後才顯示。
      </div>
    </div>

    <div id="resultMsg" class="result-msg"></div>
  </main>

  <aside class="side">
    <section class="card">
      <h3 style="margin:0 0 8px;font-size:14px;">🧠 常錯題型雷達</h3>
      <div class="tiny">(-a)+b、a+(-b)、(-a)+(-b)、(-a)-b</div>
      <div id="errorTypes" style="display:flex;flex-direction:column;gap:6px;margin-top:6px"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px;font-size:14px;">📜 最近答題</h3>
      <div id="recentLog" style="display:flex;flex-direction:column;gap:6px"></div>
    </section>
  </aside>
</div>

<!-- 設定對話框 -->
<div id="settingsModal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.45);">
  <div class="card" role="dialog" aria-modal="true" aria-labelledby="dlgTitle" style="width:min(560px,95vw); max-height:90vh; overflow:auto;">
    <h3 id="dlgTitle" style="margin:0 0 8px">⚙️ 設定</h3>
    <div style="display:grid; gap:10px;">
      <div class="row">
        <label class="tiny">暱稱（本機記錄用）</label>
        <input id="nickname" type="text" placeholder="輸入你的暱稱…" style="width:100%;border:1px solid #ddd;border-radius:10px;padding:8px"/>
      </div>
      <div class="row">
        <label class="tiny">數值範圍（含負數）</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="tiny">最小</span><input id="minVal" type="number" value="-10" style="width:100px">
          <span class="tiny">最大</span><input id="maxVal" type="number" value="10" style="width:100px">
        </div>
      </div>
      <div class="row" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
        <label class="tiny"><input id="soundOn" type="checkbox" checked> 啟用音效</label>
        <label class="tiny"><input id="autoExam" type="checkbox" checked> 熟練度 ≥80% 時提示挑戰測驗</label>
        <label class="tiny"><input id="showNumlinePractice" type="checkbox" checked> 練習模式顯示數線</label>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
        <button id="btnReset" class="flat" type="button">清除本機資料</button>
        <button id="btnCloseSettings" type="button">關閉</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 狀態與持久化 ===== */
const state = {
  mode: 'practice',
  a: 0, b: 0, sign: '+',
  settings: { minVal: -10, maxVal: 10, soundOn: true, autoExam: true, showNumlinePractice: true },
  user: { nickname: '' },
  score: 0, streak: 0, best: 0,
  history: [],
  errorBucket: { "(-a)+b":0, "a+(-b)":0, "(-a)+(-b)":0, "(-a)-b":0 },
  reviewQueue: []
};
const LS_KEY = 'neg_add_sub_mobile_ui_v4';
function save(){
  const data = { settings: state.settings, user: state.user, score: state.score, streak: state.streak, best: state.best, history: state.history.slice(-200), errorBucket: state.errorBucket };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY); if(!raw) return;
    const data = JSON.parse(raw);
    Object.assign(state.settings, data.settings||{});
    Object.assign(state.user, data.user||{});
    state.score = data.score||0;
    state.streak = data.streak||0;
    state.best = data.best||0;
    state.history = Array.isArray(data.history)? data.history : [];
    state.errorBucket = Object.assign(state.errorBucket, data.errorBucket||{});
  }catch(e){}
}

/* ===== 音效 ===== */
let audioCtx;
function beep(type='good'){
  if(!state.settings.soundOn) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value = (type==='good')?880:(type==='bad'?200:520);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.2);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.22);
  }catch(e){}
}

/* ===== 題目與分類 ===== */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function classifyType(a, sign, b){
  const Aneg=a<0, Bneg=b<0;
  if(sign==='+'){ if(Aneg&&!Bneg) return "(-a)+b"; if(!Aneg&&Bneg) return "a+(-b)"; if(Aneg&&Bneg) return "(-a)+(-b)"; }
  else{ if(a<0&&b>0) return "(-a)-b"; if(a<0&&b<0) return "(-a)-(-b)"; if(a>=0&&b>=0) return "a-b"; if(a>=0&&b<0) return "a-(-b)"; }
  return "其他";
}
// 至少一個為負，避免 0+0
function genProblem(){
  const {minVal,maxVal} = state.settings;
  let a=0,b=0,sign = Math.random()<0.5?'+':'-';
  do{ a=randInt(minVal,maxVal); b=randInt(minVal,maxVal); }while(!(a<0||b<0)||(a===0&&b===0));
  return {a,sign,b};
}

/* ===== UI 綁定 ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const elA = $('#opA'), elB = $('#opB'), elSign = $('#opSign');
const elAns = $('#answer'), elSubmit = $('#btnSubmit'), elSkip = $('#btnSkip');
const elNext = $('#btnNext');
const elMsg = $('#resultMsg'); const elScore = $('#score'), elStreak = $('#streak'), elBest = $('#best'), elMastery = $('#mastery');
const elNumline = $('#numline'); const scoreFly = $('#scoreFly');
const modal = document.getElementById('settingsModal');
const btnCloseSettings = document.getElementById('btnCloseSettings');
const btnSettings = document.getElementById('btnSettings');

function updateHeader(){ elScore.textContent=state.score; elStreak.textContent=state.streak; elBest.textContent=state.best; elMastery.textContent=Math.round(cal
