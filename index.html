<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è² æ•¸åŠ æ¸›ï½œæ•¸ç·šç·´åŠŸæˆ¿ï¼ˆæ‰‹æ©Ÿå„ªåŒ–ï¼‰</title>
<meta name="theme-color" content="#7c5cff">
<style>
  :root{
    --bg:#fff8fb;
    --card:#ffffff;
    --primary:#7c5cff;     /* æ­£ç¢ºè·¯å¾‘ï¼ˆå³ç§»ï¼‰ */
    --accent:#ff82b1;      /* æ­£ç¢ºè·¯å¾‘ï¼ˆå·¦ç§»ï¼‰ */
    --ink:#2b2b2b;
    --muted:#7a7a7a;
    --good:#17b26a;        /* ä½ çš„è·¯å¾‘ï¼Œå®Œå…¨æ­£ç¢º */
    --warn:#f59e0b;        /* ä½ çš„è·¯å¾‘ï¼Œæ–¹å‘å°ä½†æ­¥æ•¸ä¸å° */
    --bad:#ef4444;         /* ä½ çš„è·¯å¾‘ï¼Œæ–¹å‘éŒ¯èª¤ */
    --chip:#f7f7ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: linear-gradient(180deg,var(--bg),#f8fbff);
    color:var(--ink);
  }
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:12px 14px; position:sticky; top:0; backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.75); border-bottom:1px solid #eee; z-index:10;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .brand .logo{
    width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
    background: radial-gradient(circle at 30% 30%, #ffd9e8, #d9e4ff);
    box-shadow: 0 6px 16px rgba(124,92,255,0.25) inset;
    font-size:20px;
  }
  .brand h1{font-size:18px; margin:0;}
  .toolbar{display:flex; gap:8px; align-items:center;}
  .pill{
    background:var(--card); border:1px solid #eee; padding:6px 10px; border-radius:999px;
    display:flex; align-items:center; gap:8px;
  }
  input[type="text"]{
    border:none; outline:none; background:transparent; min-width:100px; font-size:14px;
  }
  button, .btn{
    cursor:pointer; border:none; padding:10px 14px; border-radius:12px; font-weight:700;
    background:var(--primary); color:white; box-shadow:0 6px 16px rgba(124,92,255,0.25);
    transition: transform .06s ease;
  }
  button.ghost{background:#f2f2ff; color:#4b4bb5; box-shadow:none}
  button.flat{background:#efefef; color:#333; box-shadow:none}
  button:active{transform: translateY(1px)}
  .layout{
    display:grid; grid-template-columns: 1fr 360px; gap:14px; padding:12px; max-width:1100px; margin:0 auto;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns: 1fr}
  }
  .card{
    background:var(--card); border:1px solid #eee; border-radius:18px; padding:14px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.04);
  }
  .scorebar{
    display:grid; grid-template-columns: repeat(4,1fr); gap:8px; margin-bottom:8px;
  }
  .chip{
    background:var(--chip); border:1px dashed #d7d7ff; border-radius:12px; padding:8px; text-align:center;
    font-weight:800; color:#4b4bb5; font-size:14px;
  }
  .big-op{
    font-size: clamp(20px, 2.2vw, 26px);
    display:flex; align-items:center; justify-content:center; gap:8px; margin:4px 0 8px; flex-wrap:wrap;
  }
  .big-op .bubble{
    background:#fff4f9; border:2px solid #ffd6ea; color:#c84580; font-weight:900;
    padding:8px 12px; border-radius:12px;
  }
  .answer-pack{
    display:flex; align-items:center; gap:6px; flex-wrap:wrap; justify-content:center;
  }
  .answer-pack input[type="text"]{
    width:130px; padding:10px; border-radius:12px; border:1px solid #ddd; font-size:20px; font-weight:800; text-align:center;
    background:#fff;
  }
  .mini-keys{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center}
  .mini-keys .k{background:#f2f2ff; color:#4b4bb5; padding:8px 10px; border-radius:10px; font-weight:800; border:1px solid #d7d7ff}
  .numline-wrap{
    background: #fff9fb;
    border:1px dashed #ffd0e6; border-radius:16px; padding:8px; margin:8px 0 6px;
  }
  .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:4px}
  .legend .tag{display:flex; align-items:center; gap:6px; font-size:12px; color:#7b3a6a}
  .dot{width:12px; height:12px; border-radius:50%}
  svg{width:100%; height:auto;}
  .answer-row{display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap; justify-content:center;}
  .result-msg{min-height:24px; font-weight:900;}
  .ok{color:var(--good)} .ng{color:var(--bad)} .warn{color:var(--warn)}
  .mode-tabs{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px; justify-content:center}
  .mode-tabs button{background:#ffeefe; color:#7b3a6a}
  .mode-tabs button.active{background:var(--accent); color:#fff}
  .right-col .section{margin-bottom:12px}
  .list{display:flex; flex-direction:column; gap:6px; max-height:360px; overflow:auto}
  .list .row{
    display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:8px 12px; border:1px solid #eee; border-radius:10px;
  }
  .tiny{font-size:12px; color:var(--muted)}
  .label{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  .rank-medal{font-size:20px}
  .footer-note{font-size:12px; color:var(--muted); text-align:center; margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">â•</div>
    <h1>è² æ•¸åŠ æ¸›ï½œæ•¸ç·šç·´åŠŸæˆ¿</h1>
  </div>
  <div class="toolbar">
    <div class="pill">
      <span>ğŸ‘¤ åç¨±</span>
      <input id="nickname" type="text" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±â€¦" />
    </div>
    <button id="btnSettings" class="ghost">âš™ï¸ è¨­å®š</button>
  </div>
</header>

<div class="layout">
  <main class="card">
    <div class="mode-tabs">
      <button data-mode="practice" class="active">ğŸŒ± ç·´ç¿’ï¼ˆæœ‰æ•¸ç·šï¼‰</button>
      <button data-mode="review">ğŸ§© éŒ¯é¡Œè¤‡ç¿’</button>
      <button data-mode="exam">ğŸ¯ æ¸¬é©—ï¼ˆç„¡æ•¸ç·šï¼‰</button>
    </div>

    <div class="scorebar">
      <div class="chip">â­ åˆ†æ•¸ <span id="score">0</span></div>
      <div class="chip">ğŸ”¥ é€£æ“Š <span id="streak">0</span></div>
      <div class="chip">ğŸ“ ç†Ÿç·´åº¦ <span id="mastery">0%</span></div>
      <div class="chip">ğŸ† æœ€é«˜åˆ† <span id="best">0</span></div>
    </div>

    <div class="big-op">
      <div class="bubble" id="opA">-3</div>
      <div class="bubble" id="opSign">-</div>
      <div class="bubble" id="opB">2</div>
      <div class="bubble">=</div>
      <div class="answer-pack">
        <!-- æ‰‹æ©Ÿè² è™Ÿï¼štext + inputmode=decimal + å°ˆç”¨ã€Œâˆ’ã€éµ -->
        <input id="answer" type="text" inputmode="decimal" pattern="-?[0-9]*" placeholder="è¼¸å…¥æ•´æ•¸â€¦" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        <div class="mini-keys">
          <button class="k" id="btnMinus" type="button">âˆ’</button>
          <button class="k" id="btnClear" type="button">æ¸…é™¤</button>
        </div>
      </div>
      <button id="btnSubmit" type="button">é€å‡º</button>
      <button id="btnSkip" class="flat" type="button">ç•¥é</button>
    </div>

    <div class="numline-wrap">
      <svg id="numlineOverlay" viewBox="0 0 800 150" preserveAspectRatio="xMidYMid meet" role="img" aria-label="æ•¸ç·šç–ŠåŠ "></svg>
      <div class="legend">
        <span class="tag"><span class="dot" style="background:var(--primary)"></span>æ­£ç¢ºè·¯å¾‘ï¼ˆå³ç§»ï¼‰</span>
        <span class="tag"><span class="dot" style="background:var(--accent)"></span>æ­£ç¢ºè·¯å¾‘ï¼ˆå·¦ç§»ï¼‰</span>
        <span class="tag"><span class="dot" style="background:var(--good)"></span>ä½ çš„è·¯å¾‘ï¼šçµ‚é»æ­£ç¢º</span>
        <span class="tag"><span class="dot" style="background:var(--warn)"></span>ä½ çš„è·¯å¾‘ï¼šæ–¹å‘å°æ­¥æ•¸éŒ¯</span>
        <span class="tag"><span class="dot" style="background:var(--bad)"></span>ä½ çš„è·¯å¾‘ï¼šæ–¹å‘éŒ¯</span>
      </div>
      <div id="overlayHint" class="tiny" style="text-align:center; margin-top:4px"></div>
    </div>

    <div class="answer-row">
      <div id="resultMsg" class="result-msg"></div>
      <button id="btnNext" class="hidden" type="button">ä¸‹ä¸€é¡Œ â–¶</button>
      <button id="btnShowSteps" class="ghost hidden" type="button">é¡¯ç¤ºæ­¥é©Ÿ</button>
    </div>

    <div class="footer-note">æç¤ºï¼šç·´ç¿’/è¤‡ç¿’æœƒé¡¯ç¤ºæ•¸ç·šï¼›æ¸¬é©—æ¨¡å¼å…ˆä¸é¡¯ç¤ºï¼Œé€å‡ºå¾Œå†é¡¯ç¤ºæ­£ç¢ºè·¯å¾‘èˆ‡å·®ç•°ã€‚</div>
  </main>

  <aside class="right-col">
    <div class="card section">
      <h3>ğŸ§  å¸¸éŒ¯é¡Œå‹é›·é”</h3>
      <div class="tiny">å››å¤§å‹æ…‹ï¼š(-a)+bã€a+(-b)ã€(-a)+(-b)ã€(-a)-b</div>
      <div class="list" id="errorTypes"></div>
    </div>

    <div class="card section">
      <h3>ğŸ“œ æœ€è¿‘ç­”é¡Œ</h3>
      <div class="list" id="recentLog"></div>
    </div>
  </aside>
</div>

<!-- è¨­å®šå°è©±æ¡† -->
<div id="settingsModal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.4);">
  <div class="card" style="width:min(760px,95vw); max-height:90vh; overflow:auto;">
    <h3>âš™ï¸ è¨­å®š</h3>
    <div style="display:grid; gap:10px;">
      <div class="row">
        <label class="label">æ•¸å€¼ç¯„åœï¼ˆå«è² æ•¸ï¼‰ï¼š</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <span>æœ€å°</span><input id="minVal" type="number" value="-10" style="width:100px">
          <span>æœ€å¤§</span><input id="maxVal" type="number" value="10" style="width:100px">
        </div>
      </div>
      <div class="row" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
        <label><input id="soundOn" type="checkbox" checked> å•Ÿç”¨éŸ³æ•ˆ</label>
        <label><input id="autoExam" type="checkbox" checked> ç†Ÿç·´åº¦ â‰¥80% æ™‚æç¤ºæŒ‘æˆ°æ¸¬é©—</label>
        <label><input id="showNumlinePractice" type="checkbox" checked> ç·´ç¿’æ¨¡å¼é¡¯ç¤ºæ•¸ç·š</label>
      </div>
      <div class="row">
        <div class="label">ç†Ÿç·´åº¦ï¼šä»¥æœ€è¿‘ 50 é¡Œæ­£ç¢ºç‡ç‚ºåŸºç¤ï¼›éŒ¯é¡Œè¤‡ç¿’å‘½ä¸­å¯åŠ é€Ÿæå‡ã€‚</div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
        <button id="btnReset" class="flat" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <button id="btnCloseSettings" type="button">é—œé–‰</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== ç‹€æ…‹èˆ‡æŒä¹…åŒ– ===== */
const state = {
  mode: 'practice',
  a: 0, b: 0, sign: '+',
  settings: { minVal: -10, maxVal: 10, soundOn: true, autoExam: true, showNumlinePractice: true },
  user: { nickname: '' },
  score: 0, streak: 0, best: 0,
  history: [],
  errorBucket: { "(-a)+b":0, "a+(-b)":0, "(-a)+(-b)":0, "(-a)-b":0 },
  reviewQueue: []
};
const LS_KEY = 'neg_add_sub_final_v1';
function save(){
  const data = { settings: state.settings, user: state.user, score: state.score, streak: state.streak, best: state.best, history: state.history.slice(-200), errorBucket: state.errorBucket };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY); if(!raw) return;
    const data = JSON.parse(raw);
    Object.assign(state.settings, data.settings||{});
    Object.assign(state.user, data.user||{});
    state.score = data.score||0;
    state.streak = data.streak||0;
    state.best = data.best||0;
    state.history = Array.isArray(data.history)? data.history : [];
    state.errorBucket = Object.assign(state.errorBucket, data.errorBucket||{});
  }catch(e){}
}

/* ===== éŸ³æ•ˆ ===== */
let audioCtx;
function beep(type='good'){
  if(!state.settings.soundOn) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value = (type==='good')?880:(type==='bad'?200:520);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.2);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.22);
  }catch(e){}
}

/* ===== é¡Œç›®èˆ‡åˆ†é¡ ===== */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function classifyType(a, sign, b){
  const Aneg=a<0, Bneg=b<0;
  if(sign==='+'){ if(Aneg&&!Bneg) return "(-a)+b"; if(!Aneg&&Bneg) return "a+(-b)"; if(Aneg&&Bneg) return "(-a)+(-b)"; }
  else{ if(a<0&&b>0) return "(-a)-b"; if(a<0&&b<0) return "(-a)-(-b)"; if(a>=0&&b>=0) return "a-b"; if(a>=0&&b<0) return "a-(-b)"; }
  return "å…¶ä»–";
}
// è‡³å°‘ä¸€å€‹ç‚ºè² ï¼Œé¿å… 0+0
function genProblem(){
  const {minVal,maxVal} = state.settings;
  let a=0,b=0,sign = Math.random()<0.5?'+':'-';
  do{ a=randInt(minVal,maxVal); b=randInt(minVal,maxVal); }while(!(a<0||b<0)||(a===0&&b===0));
  return {a,sign,b};
}

/* ===== UI ç¶å®š ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const elA = $('#opA'), elB = $('#opB'), elSign = $('#opSign');
const elAns = $('#answer'), elSubmit = $('#btnSubmit'), elSkip = $('#btnSkip');
const elNext = $('#btnNext'), elShowSteps = $('#btnShowSteps');
const elMsg = $('#resultMsg'); const elScore = $('#score'), elStreak = $('#streak'), elBest = $('#best'), elMastery = $('#mastery');
const elNickname = $('#nickname'); const elOverlay = $('#numlineOverlay'); const elOverlayHint = $('#overlayHint');
const btnMinus = $('#btnMinus'), btnClear = $('#btnClear');

function updateHeader(){ elScore.textContent=state.score; elStreak.textContent=state.streak; elBest.textContent=state.best; elMastery.textContent=Math.round(calcMastery()*100)+'%'; elNickname.value=state.user.nickname||''; }

function setProblem(p){
  state.a=p.a; state.sign=p.sign; state.b=p.b;
  elA.textContent=p.a; elB.textContent=p.b; elSign.textContent=p.sign;
  elAns.value=''; elAns.focus({preventScroll:true}); elMsg.textContent=''; elNext.classList.add('hidden'); elShowSteps.classList.add('hidden');
  const showCorrect = (state.mode!=='exam') && (!!state.settings.showNumlinePractice || state.mode==='review');
  renderOverlay(null, showCorrect);
}

function nextProblem(){
  if((state.mode==='review') && state.reviewQueue.length>0){ const q=state.reviewQueue.shift(); setProblem(q); return; }
  if(state.mode==='review' && state.reviewQueue.length===0){ switchMode('practice'); return; }
  setProblem(genProblem());
}

function calcMastery(){ const N=50; const recent=state.history.slice(-N); if(recent.length===0) return 0; return recent.filter(h=>h.correct).length/recent.length; }
function pushHistory(rec){ state.history.push(rec); if(!rec.correct){ state.reviewQueue.push({a:rec.a,sign:rec.sign,b:rec.b}); if(state.reviewQueue.length>50) state.reviewQueue.shift(); } save(); renderRightPanels(); }

/* ===== ç–ŠåŠ æ•¸ç·šæ¸²æŸ“ ===== */
function renderOverlay(userAns, showCorrect=true){
  const a=state.a, sign=state.sign, b=state.b;
  const expectedDelta = (sign==='+'? b : -b);
  const expectedEnd = a + expectedDelta;
  const userDelta = (typeof userAns==='number' && Number.isFinite(userAns)) ? userAns - a : null;
  const userEnd = userDelta===null ? null : a + userDelta;

  const min = Math.min(state.settings.minVal, a, expectedEnd, userEnd??a) - 1;
  const max = Math.max(state.settings.maxVal, a, expectedEnd, userEnd??a) + 1;
  const w=780, h=150, pad=40;
  const scale = x => pad + (x - min) * ((w-2*pad)/Math.max(1,(max-min)));

  const ticks = [];
  for(let x=min; x<=max; x++){
    const X = scale(x);
    const isZero = (x===0);
    ticks.push(`<line x1="${X}" y1="${h-45}" x2="${X}" y2="${h-35}" stroke="${isZero?'#c84580':'#888'}" stroke-width="${isZero?2:1}"/>`);
    ticks.push(`<text x="${X}" y="${h-18}" text-anchor="middle" font-size="12" fill="${isZero?'#c84580':'#555'}" font-weight="${isZero?700:400}">${x}</text>`);
  }
  const base = `
    <line x1="${scale(min)}" y1="${h-40}" x2="${scale(max)}" y2="${h-40}" stroke="#444" stroke-width="2"/>
    ${ticks.join('')}
  `;

  // æ­£ç¢ºè·¯å¾‘ï¼ˆç´«/ç²‰ï¼‰ï¼šä¸€æ­¥ä¸€å¼§ï¼ˆåƒ…åœ¨ showCorrect=true æ™‚é¡¯ç¤ºï¼‰
  let correctLayer = '';
  if(showCorrect){
    const correctDir = expectedDelta>=0 ? 1 : -1;
    const correctColor = expectedDelta>=0 ? 'var(--primary)' : 'var(--accent)';
    let correctPath=''; let cur=a;
    for(let i=0;i<Math.abs(expectedDelta);i++){
      const x1=scale(cur), x2=scale(cur+correctDir), mid=(x1+x2)/2, arcH=24+Math.min(i*3,18);
      correctPath += `<path d="M ${x1} ${h-42} Q ${mid} ${h-42-arcH} ${x2} ${h-42}" fill="none" stroke="${correctColor}" stroke-width="2" marker-end="url(#arrowC)"/>`;
      cur+=correctDir;
    }
    correctLayer += `<circle cx="${scale(expectedEnd)}" cy="${h-40}" r="6" fill="${correctDir>0?'var(--primary)':'var(--accent)'}" />`;
    correctLayer = correctPath + correctLayer;
  }

  // ä½ çš„è·¯å¾‘ï¼ˆç¶ /æ©˜/ç´…ï¼‰ï¼šä¾å·®ç•°è‘—è‰²
  let yourPath=''; let yourDots=''; let diffMark=''; let hint='';
  const startX = scale(a);
  yourDots += `<circle cx="${startX}" cy="${h-40}" r="6" fill="#4b4bb5" />`;
  let statusClass = '';

  if(userDelta!==null){
    const sameDir = Math.sign(userDelta) === Math.sign(expectedDelta);
    const correctEnd = userEnd === expectedEnd;
    let yourColor = '#999';
    if(correctEnd){ yourColor='var(--good)'; statusClass='ok'; hint=`âœ… æ­¥æ•¸ ${Math.abs(userDelta)}ã€æ–¹å‘ ${userDelta>=0?'å³':'å·¦'}ï¼Œçµ‚é»æ­£ç¢ºã€‚`; }
    else if(sameDir){ yourColor='var(--warn)'; statusClass='warn'; hint=`âš ï¸ æ–¹å‘æ­£ç¢ºï¼Œä½†æ­¥æ•¸ ${Math.abs(userDelta)} â‰  é æœŸ ${Math.abs(expectedDelta)}ã€‚`; }
    else{ yourColor='var(--bad)'; statusClass='ng'; hint=`âŒ æ–¹å‘éŒ¯èª¤ï¼Œæ‡‰å¾€ ${expectedDelta>=0?'å³':'å·¦'} ${Math.abs(expectedDelta)} æ­¥ã€‚`; }

    let curA=a; const dir = userDelta>=0 ? 1 : -1;
    for(let i=0;i<Math.abs(userDelta);i++){
      const x1=scale(curA), x2=scale(curA+dir), mid=(x1+x2)/2, arcH=20+Math.min(i*3,18);
      yourPath += `<path d="M ${x1} ${h-46} Q ${mid} ${h-46-arcH} ${x2} ${h-46}" fill="none" stroke="${yourColor}" stroke-width="2.5" marker-end="url(#arrowU)" opacity="0.95"/>`;
      curA+=dir;
    }
    yourDots += `<circle cx="${scale(userEnd)}" cy="${h-40}" r="6" fill="${yourColor}" />`;

    if(showCorrect && !correctEnd){
      const x1 = scale(userEnd), x2 = scale(expectedEnd);
      diffMark = `<line x1="${x1}" y1="${h-32}" x2="${x2}" y2="${h-32}" stroke="${yourColor}" stroke-width="2" stroke-dasharray="6 4" />
                  <text x="${(x1+x2)/2}" y="${h-36}" text-anchor="middle" font-size="12" fill="${yourColor}">å·®è· ${Math.abs(userEnd-expectedEnd)}</text>`;
    }
    elOverlayHint.className = 'tiny ' + statusClass;
    elOverlayHint.textContent = hint;
  }else{
    elOverlayHint.className = 'tiny';
    elOverlayHint.textContent = showCorrect
      ? 'åœ¨æ•¸ç·šä¸Šæƒ³åƒä¸€æ­¥ä¸€æ­¥ç§»å‹•ï¼›è¼¸å…¥ç­”æ¡ˆå¯å³æ™‚ç–ŠåŠ ä½ çš„è·¯å¾‘èˆ‡å·®ç•°ã€‚'
      : 'æ¸¬é©—æ¨¡å¼ï¼šå…ˆæ€è€ƒå¾Œä½œç­”ï¼Œé€å‡ºå¾Œæœƒé¡¯ç¤ºæ­£ç¢ºè·¯å¾‘èˆ‡å·®ç•°ã€‚';
  }

  elOverlay.innerHTML = `
    <defs>
      <marker id="arrowC" markerWidth="12" markerHeight="12" refX="8" refY="6" orient="auto-start-reverse">
        <path d="M0,0 L12,6 L0,12 z" fill="${expectedDelta>=0?'var(--primary)':'var(--accent)'}"></path>
      </marker>
      <marker id="arrowU" markerWidth="12" markerHeight="12" refX="8" refY="6" orient="auto-start-reverse">
        <path d="M0,0 L12,6 L0,12 z" fill="#000"></path>
      </marker>
    </defs>
    ${base}
    ${correctLayer}
    ${yourPath}
    ${yourDots}
    ${diffMark}
  `;
}

/* ===== æª¢æŸ¥ç­”æ¡ˆã€è¨ˆåˆ† ===== */
function submitAnswer(){
  const raw = elAns.value.trim();
  if(!/^[-]?\\d+$/.test(raw)){
    elMsg.textContent = 'è«‹è¼¸å…¥æ•´æ•¸ï¼ˆå¯å«è² è™Ÿï¼‰';
    elMsg.className = 'result-msg ng'; beep('bad'); return;
  }
  const userAns = parseInt(raw,10);
  renderOverlay(userAns, /*showCorrect=*/true); // é€å‡ºå¾Œé¡¯ç¤ºæ­£ç¢ºè·¯å¾‘ä»¥æ¯”å°

  const {a,b,sign} = state;
  const correctAns = sign==='+' ? a+b : a-b;
  const ok = (userAns===correctAns);

  const rec = {a,b,sign,ans:userAns,correct:ok, ts:Date.now()}; pushHistory(rec);
  const typ = classifyType(a, sign, b); if(state.errorBucket[typ]!==undefined && !ok){ state.errorBucket[typ]+=1; }

  if(ok){
    beep('good'); state.streak += 1;
    const bonus = 10 + Math.min(state.streak*2, 30); state.score += bonus;
    elMsg.innerHTML = `âœ… æ­£ç¢ºï¼<span class="tiny">(+${bonus} åˆ†)</span>`; elMsg.className='result-msg ok';
  }else{
    beep('bad'); state.streak = 0; state.score = Math.max(0, state.score - 3);
    elMsg.innerHTML = `âŒ ä¸æ­£ç¢ºï¼Œæ­£è§£ç‚º <b>${correctAns}</b>`; elMsg.className='result-msg ng';
    if(state.mode==='exam'){ elShowSteps.classList.remove('hidden'); }
  }
  if(state.score>state.best){ state.best = state.score; }

  if(state.settings.autoExam){
    const m = calcMastery(); if(m>=0.8){ elMsg.innerHTML += `ã€€ğŸ‰ ç†Ÿç·´åº¦ <b>${Math.round(m*100)}%</b>ï¼Œå¯æŒ‘æˆ°ã€Œæ¸¬é©—ï¼ˆç„¡æ•¸ç·šï¼‰ã€ï¼`; }
  }
  elNext.classList.remove('hidden'); updateHeader(); save(); renderRightPanels();
}

function skipQuestion(){ elMsg.textContent='å·²ç•¥éï¼Œæ›ä¸€é¡Œï¼'; elMsg.className='result-msg'; state.streak=0; updateHeader(); nextProblem(); }
function switchMode(m){
  state.mode = m; $$('.mode-tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.mode===m));
  nextProblem();
}

/* ===== å³å´é¢æ¿ ===== */
function renderRightPanels(){
  const et = $('#errorTypes'); et.innerHTML='';
  const items = Object.entries(state.errorBucket);
  if(items.every(([k,v])=>v===0)){ et.innerHTML = `<div class="tiny">å¤ªè®šäº†ï¼ç›®å‰æ²’æœ‰æ˜é¡¯çš„å¸¸éŒ¯å‹æ…‹ã€‚</div>`; }
  else{
    for(const [k,v] of items){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `<div>${k}</div><div class="tiny">éŒ¯ <b>${v}</b> æ¬¡</div>`; et.appendChild(row);
    }
  }
  const log = $('#recentLog'); log.innerHTML=''; const last = state.history.slice(-10).reverse();
  if(last.length===0){ log.innerHTML = `<div class="tiny">å°šç„¡è³‡æ–™</div>`; }
  else{
    last.forEach(r=>{
      const row=document.createElement('div'); row.className='row';
      const ans = r.sign==='+'? r.a+r.b : r.a-r.b;
      row.innerHTML = `<div>${r.a} ${r.sign} ${r.b} = ${ans}</div><div class="${r.correct?'ok':'ng'}">${r.correct?'âœ”ï¸':'âœ–ï¸'}</div>`;
      log.appendChild(row);
    });
  }
}

/* ===== è¨­å®šé¢æ¿ ===== */
const modal = $('#settingsModal');
$('#btnSettings').addEventListener('click', ()=>{
  $('#minVal').value=state.settings.minVal; $('#maxVal').value=state.settings.maxVal;
  $('#soundOn').checked=state.settings.soundOn; $('#autoExam').checked=state.settings.autoExam; $('#showNumlinePractice').checked=state.settings.showNumlinePractice;
  modal.classList.remove('hidden');
});
$('#btnCloseSettings').addEventListener('click', ()=> modal.classList.add('hidden'));
$('#btnReset').addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿå­¸ç¿’è³‡æ–™å—ï¼Ÿ')){ localStorage.removeItem(LS_KEY); location.reload(); }
});
$('#minVal').addEventListener('change', e=>{ state.settings.minVal=Number(e.target.value); save(); renderOverlay(null, state.mode!=='exam'); });
$('#maxVal').addEventListener('change', e=>{ state.settings.maxVal=Number(e.target.value); save(); renderOverlay(null, state.mode!=='exam'); });
$('#soundOn').addEventListener('change', e=>{ state.settings.soundOn=!!e.target.checked; save(); });
$('#autoExam').addEventListener('change', e=>{ state.settings.autoExam=!!e.target.checked; save(); });
$('#showNumlinePractice').addEventListener('change', e=>{ state.settings.showNumlinePractice=!!e.target.checked; save(); });

$('#nickname').addEventListener('change', e=>{ state.user.nickname=e.target.value.trim(); save(); });

/* ===== äº‹ä»¶ï¼šç­”é¡Œ & å³æ™‚ç–ŠåŠ ï¼ˆè¡Œå‹•ç‰ˆå¯é è§¸ç™¼ï¼‰ ===== */
const submitAnswerPointerSafe = ()=> submitAnswer();
elSubmit.addEventListener('click', submitAnswerPointerSafe);
elSubmit.addEventListener('pointerup', submitAnswerPointerSafe); // è¡Œå‹•è£ç½®
elAns.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitAnswer(); });
elAns.addEventListener('input', ()=>{
  const raw=elAns.value.trim();
  if(/^[-]?\\d+$/.test(raw)){ renderOverlay(parseInt(raw,10), state.mode!=='exam'); }
  else if(raw===''){ renderOverlay(null, state.mode!=='exam'); }
});
elSkip.addEventListener('click', ()=>{ skipQuestion(); });
elSkip.addEventListener('pointerup', ()=>{ skipQuestion(); });
btnMinus.addEventListener('click', ()=>{
  const v = elAns.value;
  if(v.startsWith('-')){ elAns.value = v.slice(1); }
  else{ elAns.value = v ? ('-'+v) : '-'; }
  elAns.focus({preventScroll:true});
  elAns.dispatchEvent(new Event('input'));
});
btnClear.addEventListener('click', ()=>{ elAns.value=''; elAns.focus({preventScroll:true}); elAns.dispatchEvent(new Event('input')); });

/* ===== åˆå§‹åŒ– ===== */
function init(){ load(); updateHeader(); renderRightPanels(); nextProblem(); document.addEventListener('gesturestart', e=>e.preventDefault()); }
init();
</script>
</body>
</html>
