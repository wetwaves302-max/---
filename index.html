<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>負數加減｜數線練功房</title>
<meta name="theme-color" content="#7c5cff">
<style>
  :root{
    --bg:#fff8fb;
    --card:#ffffff;
    --primary:#7c5cff;     /* 正確路徑（右移） */
    --accent:#ff82b1;      /* 正確路徑（左移） */
    --ink:#222;
    --muted:#7a7a7a;
    --good:#17b26a;
    --bad:#ef4444;
    --chip:#f7f7ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: linear-gradient(180deg,var(--bg),#f8fbff);
    color:var(--ink);
    -webkit-tap-highlight-color: transparent;
  }
  /* Compact mobile header */
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 10px; position:sticky; top:0; backdrop-filter: blur(6px);
    background:rgba(255,255,255,0.88); border-bottom:1px solid #eee; z-index:10;
  }
  .brand{display:flex; align-items:center; gap:8px; min-width:0}
  .brand .logo{
    width:26px; height:26px; border-radius:8px; display:grid; place-items:center;
    background: radial-gradient(circle at 30% 30%, #ffd9e8, #d9e4ff);
    box-shadow: 0 6px 16px rgba(124,92,255,0.25) inset;
    font-size:14px;
  }
  .brand h1{font-size:14px; line-height:1; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .toolbar{display:flex; gap:6px; align-items:center;}
  button, .btn{
    cursor:pointer; border:none; padding:10px 14px; border-radius:12px; font-weight:700;
    background:var(--primary); color:white; box-shadow:0 6px 16px rgba(124,92,255,0.25);
    transition: transform .06s ease;
  }
  button.ghost{background:#f2f2ff; color:#4b4bb5; box-shadow:none}
  button.flat{background:#efefef; color:#333; box-shadow:none}
  button:active{transform: translateY(1px)}
  /* Mobile-first layout */
  .layout{
    display:grid; grid-template-columns: 1fr; gap:10px; padding:10px; max-width:720px; margin:0 auto;
  }
  .card{
    background:var(--card); border:1px solid #eee; border-radius:14px; padding:12px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.04);
  }
  .mode-tabs{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; justify-content:center}
  .mode-tabs button{background:#ffeefe; color:#7b3a6a; padding:8px 10px; border-radius:10px}
  .mode-tabs button.active{background:var(--accent); color:#fff}
  .scorebar{
    display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-bottom:6px;
  }
  .chip{
    background:var(--chip); border:1px dashed #d7d7ff; border-radius:10px; padding:6px; text-align:center;
    font-weight:800; color:#4b4bb5; font-size:13px;
    position:relative;
  }
  .score-fly{
    position:absolute; left:50%; top:-2px; transform:translate(-50%,0);
    font-size:12px; font-weight:900; opacity:0; pointer-events:none;
    transition: transform .6s ease, opacity .6s ease;
  }
  .score-fly.show{opacity:1; transform:translate(-50%,-18px);}
  .big-op{
    font-size: clamp(18px, 4.5vw, 22px);
    display:flex; align-items:center; justify-content:center; gap:8px; margin:4px 0 8px; flex-wrap:wrap;
  }
  .big-op .bubble{
    background:#fff4f9; border:2px solid #ffd6ea; color:#c84580; font-weight:900;
    padding:6px 10px; border-radius:10px;
  }
  .answer-pack{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; justify-content:center; }
  .answer-pack input[type="text"]{
    width:120px; padding:10px; border-radius:12px; border:1px solid #ddd; font-size:20px; font-weight:800; text-align:center;
    background:#fff;
  }
  .mini-keys{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:center}
  .mini-keys .k{background:#f2f2ff; color:#4b4bb5; padding:8px 10px; border-radius:10px; font-weight:800; border:1px solid #d7d7ff}
  .controls{display:flex; gap:6px; justify-content:center; flex-wrap:wrap; margin-top:6px}
  .controls button{min-width:92px}
  .numline-wrap{
    background: #fff9fb;
    border:1px dashed #ffd0e6; border-radius:14px; padding:8px; margin:8px 0 6px;
  }
  svg{width:100%; height:auto;}
  .result-msg{min-height:24px; font-weight:900; text-align:center; margin-top:4px}
  .ok{color:var(--good)} .ng{color:var(--bad)}
  .tiny{font-size:12px; color:var(--muted); text-align:center}
  .side{display:grid; gap:10px}
  @media (min-width: 900px){
    .layout{grid-template-columns: 1fr 320px; max-width:1100px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">➕</div>
    <h1>負數加減｜數線練功房</h1>
  </div>
  <div class="toolbar">
    <button id="btnSettings" class="ghost" aria-label="設定">⚙️</button>
  </div>
</header>

<div class="layout">
  <main class="card">
    <div class="mode-tabs">
      <button data-mode="practice" class="active">🌱 練習（有數線）</button>
      <button data-mode="review">🧩 錯題複習</button>
      <button data-mode="exam">🎯 測驗（無數線）</button>
    </div>

    <div class="scorebar">
      <div class="chip">⭐ 分數 <span id="score">0</span><span id="scoreFly" class="score-fly">+0</span></div>
      <div class="chip">🔥 連擊 <span id="streak">0</span></div>
      <div class="chip">🎓 熟練度 <span id="mastery">0%</span></div>
      <div class="chip">🏆 最高分 <span id="best">0</span></div>
    </div>

    <div class="big-op">
      <div class="bubble" id="opA">-3</div>
      <div class="bubble" id="opSign">-</div>
      <div class="bubble" id="opB">2</div>
      <div class="bubble">=</div>
      <div class="answer-pack">
        <input id="answer" type="text" inputmode="decimal" pattern="-?[0-9]*" placeholder="輸入整數…" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
        <div class="mini-keys">
          <button class="k" id="btnMinus" type="button">−</button>
          <button class="k" id="btnClear" type="button">清除</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="btnSubmit" type="button">送出</button>
      <button id="btnNext" class="ghost" type="button">下一題 ▶</button>
      <button id="btnSkip" class="flat" type="button">略過</button>
    </div>

    <div class="numline-wrap">
      <svg id="numline" viewBox="0 0 800 150" preserveAspectRatio="xMidYMid meet" role="img" aria-label="數線"></svg>
      <div class="tiny">
        練習/複習：顯示正確步驟；測驗：送出後才顯示。
      </div>
    </div>

    <div id="resultMsg" class="result-msg"></div>
  </main>

  <aside class="side">
    <section class="card">
      <h3 style="margin:0 0 8px;font-size:14px;">🧠 常錯題型雷達</h3>
      <div class="tiny">(-a)+b、a+(-b)、(-a)+(-b)、(-a)-b</div>
      <div id="errorTypes" style="display:flex;flex-direction:column;gap:6px;margin-top:6px"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px;font-size:14px;">📜 最近答題</h3>
      <div id="recentLog" style="display:flex;flex-direction:column;gap:6px"></div>
    </section>
  </aside>
</div>

<!-- 設定對話框 -->
<div id="settingsModal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.45);">
  <div class="card" style="width:min(560px,95vw); max-height:90vh; overflow:auto;">
    <h3 style="margin:0 0 8px">⚙️ 設定</h3>
    <div style="display:grid; gap:10px;">
      <div class="row">
        <label class="tiny">暱稱（本機記錄用）</label>
        <input id="nickname" type="text" placeholder="輸入你的暱稱…" style="width:100%;border:1px solid #ddd;border-radius:10px;padding:8px"/>
      </div>
      <div class="row">
        <label class="tiny">數值範圍（含負數）</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="tiny">最小</span><input id="minVal" type="number" value="-10" style="width:100px">
          <span class="tiny">最大</span><input id="maxVal" type="number" value="10" style="width:100px">
        </div>
      </div>
      <div class="row" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
        <label class="tiny"><input id="soundOn" type="checkbox" checked> 啟用音效</label>
        <label class="tiny"><input id="autoExam" type="checkbox" checked> 熟練度 ≥80% 時提示挑戰測驗</label>
        <label class="tiny"><input id="showNumlinePractice" type="checkbox" checked> 練習模式顯示數線</label>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
        <button id="btnReset" class="flat" type="button">清除本機資料</button>
        <button id="btnCloseSettings" type="button">關閉</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 狀態與持久化 ===== */
const state = {
  mode: 'practice',
  a: 0, b: 0, sign: '+',
  settings: { minVal: -10, maxVal: 10, soundOn: true, autoExam: true, showNumlinePractice: true },
  user: { nickname: '' },
  score: 0, streak: 0, best: 0,
  history: [],
  errorBucket: { "(-a)+b":0, "a+(-b)":0, "(-a)+(-b)":0, "(-a)-b":0 },
  reviewQueue: []
};
const LS_KEY = 'neg_add_sub_mobile_ui_v3';
function save(){
  const data = { settings: state.settings, user: state.user, score: state.score, streak: state.streak, best: state.best, history: state.history.slice(-200), errorBucket: state.errorBucket };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY); if(!raw) return;
    const data = JSON.parse(raw);
    Object.assign(state.settings, data.settings||{});
    Object.assign(state.user, data.user||{});
    state.score = data.score||0;
    state.streak = data.streak||0;
    state.best = data.best||0;
    state.history = Array.isArray(data.history)? data.history : [];
    state.errorBucket = Object.assign(state.errorBucket, data.errorBucket||{});
  }catch(e){}
}

/* ===== 音效 ===== */
let audioCtx;
function beep(type='good'){
  if(!state.settings.soundOn) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value = (type==='good')?880:(type==='bad'?200:520);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.2);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.22);
  }catch(e){}
}

/* ===== 題目與分類 ===== */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function classifyType(a, sign, b){
  const Aneg=a<0, Bneg=b<0;
  if(sign==='+'){ if(Aneg&&!Bneg) return "(-a)+b"; if(!Aneg&&Bneg) return "a+(-b)"; if(Aneg&&Bneg) return "(-a)+(-b)"; }
  else{ if(a<0&&b>0) return "(-a)-b"; if(a<0&&b<0) return "(-a)-(-b)"; if(a>=0&&b>=0) return "a-b"; if(a>=0&&b<0) return "a-(-b)"; }
  return "其他";
}
// 至少一個為負，避免 0+0
function genProblem(){
  const {minVal,maxVal} = state.settings;
  let a=0,b=0,sign = Math.random()<0.5?'+':'-';
  do{ a=randInt(minVal,maxVal); b=randInt(minVal,maxVal); }while(!(a<0||b<0)||(a===0&&b===0));
  return {a,sign,b};
}

/* ===== UI 綁定 ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const elA = $('#opA'), elB = $('#opB'), elSign = $('#opSign');
const elAns = $('#answer'), elSubmit = $('#btnSubmit'), elSkip = $('#btnSkip');
const elNext = $('#btnNext');
const elMsg = $('#resultMsg'); const elScore = $('#score'), elStreak = $('#streak'), elBest = $('#best'), elMastery = $('#mastery');
const elNumline = $('#numline'); const scoreFly = $('#scoreFly');

function updateHeader(){ elScore.textContent=state.score; elStreak.textContent=state.streak; elBest.textContent=state.best; elMastery.textContent=Math.round(calcMastery()*100)+'%'; }

function setProblem(p){
  state.a=p.a; state.sign=p.sign; state.b=p.b;
  elA.textContent=p.a; elB.textContent=p.b; elSign.textContent=p.sign;
  elAns.value=''; elMsg.textContent='';
  const showNow = (state.mode!=='exam') && (!!state.settings.showNumlinePractice || state.mode==='review');
  drawNumberLine(p.a, p.sign, p.b, showNow ? (p.sign==='+'? p.a+p.b : p.a-p.b) : null);
}

function nextProblem(){
  if((state.mode==='review') && state.reviewQueue.length>0){ const q=state.reviewQueue.shift(); setProblem(q); return; }
  if(state.mode==='review' && state.reviewQueue.length===0){ switchMode('practice'); return; }
  setProblem(genProblem());
}

function calcMastery(){ const N=50; const recent=state.history.slice(-N); if(recent.length===0) return 0; return recent.filter(h=>h.correct).length/recent.length; }
function pushHistory(rec){ state.history.push(rec); if(!rec.correct){ state.reviewQueue.push({a:rec.a,sign:rec.sign,b:rec.b}); if(state.reviewQueue.length>50) state.reviewQueue.shift(); } save(); renderRightPanels(); }

/* ===== 數線（僅系統示意） ===== */
function drawNumberLine(a, sign, b, answerOrNull){
  const {minVal, maxVal} = state.settings;
  const result = sign==='+' ? a+b : a-b;
  const min = Math.min(minVal, a, result) - 1;
  const max = Math.max(maxVal, a, result) + 1;
  const w=780, h=150, pad=40;
  const scale = x => pad + (x - min) * ((w-2*pad)/Math.max(1,(max-min)));
  const steps = (sign==='+'? b : -b);
  const dir = steps>=0 ? 1 : -1;
  const nSteps = Math.abs(steps);

  let ticks='';
  for(let x=min; x<=max; x++){
    const X = scale(x);
    const isZero = (x===0);
    ticks += `<line x1="${X}" y1="${h-45}" x2="${X}" y2="${h-35}" stroke="${isZero?'#c84580':'#888'}" stroke-width="${isZero?2:1}" />`;
    ticks += `<text x="${X}" y="${h-18}" text-anchor="middle" font-size="12" fill="${isZero?'#c84580':'#555'}" font-weight="${isZero?700:400}">${x}</text>`;
  }
  const base = `<line x1="${scale(min)}" y1="${h-40}" x2="${scale(max)}" y2="${h-40}" stroke="#444" stroke-width="2" />${ticks}`;

  let arcs=''; let cur=a;
  const correctColor = dir>0 ? 'var(--primary)' : 'var(--accent)';
  for(let i=0;i<nSteps;i++){
    const x1=scale(cur), x2=scale(cur+dir), mid=(x1+x2)/2, arcH=24+Math.min(i*3,18);
    arcs += `<path d="M ${x1} ${h-42} Q ${mid} ${h-42-arcH} ${x2} ${h-42}" fill="none" stroke="${correctColor}" stroke-width="2" marker-end="url(#arrow)"/>`;
    cur+=dir;
  }

  const nowDot = `<circle cx="${scale(a)}" cy="${h-40}" r="6" fill="#4b4bb5" />`;
  const resDot = (answerOrNull!==null) ? `<circle cx="${scale(result)}" cy="${h-40}" r="6" fill="${correctColor}" />` : '';

  elNumline.innerHTML = `
    <defs>
      <marker id="arrow" markerWidth="12" markerHeight="12" refX="8" refY="6" orient="auto-start-reverse">
        <path d="M0,0 L12,6 L0,12 z" fill="${correctColor}"></path>
      </marker>
    </defs>
    ${base}
    ${arcs}
    ${nowDot}
    ${resDot}
  `;
}

/* ===== 檢查答案、計分（即時反應 + 分數動畫） ===== */
function submitAnswer(){
  const raw = elAns.value.trim();
  if(!/^[-]?\\d+$/.test(raw)){
    // 不顯示「請輸入整數」，若輸入無效就忽略
    return;
  }
  const userAns = parseInt(raw,10);
  const {a,b,sign} = state;
  const correctAns = sign==='+' ? a+b : a-b;
  const ok = (userAns===correctAns);

  // 顯示正確步驟與終點（測驗也在送出後顯示）
  drawNumberLine(a, sign, b, correctAns);

  const rec = {a,b,sign,ans:userAns,correct:ok, ts:Date.now()}; pushHistory(rec);

  if(ok){
    beep('good'); state.streak += 1;
    const bonus = 10 + Math.min(state.streak*2, 30); state.score += bonus;
    elMsg.textContent = '答對';
    elMsg.className='result-msg ok';
    // 分數動畫
    scoreFly.textContent = `+${bonus}`;
    scoreFly.style.color = 'var(--good)';
    scoreFly.classList.add('show');
    setTimeout(()=> scoreFly.classList.remove('show'), 650);
  }else{
    beep('bad'); state.streak = 0; state.score = Math.max(0, state.score - 3);
    elMsg.textContent = '答錯';
    elMsg.className='result-msg ng';
    // 錯誤不加分，但也做個微動畫提示
    scoreFly.textContent = `-3`;
    scoreFly.style.color = 'var(--bad)';
    scoreFly.classList.add('show');
    setTimeout(()=> scoreFly.classList.remove('show'), 650);
  }

  if(state.score>state.best){ state.best = state.score; }
  updateHeader(); save(); renderRightPanels();
}

function skipQuestion(){ elMsg.textContent=''; state.streak=0; updateHeader(); nextProblem(); }
function switchMode(m){
  state.mode = m; $$('.mode-tabs button').forEach(btn=>btn.classList.toggle('active', btn.dataset.mode===m));
  nextProblem();
}

/* ===== 右側面板 ===== */
function renderRightPanels(){
  const et = $('#errorTypes'); et.innerHTML='';
  const items = Object.entries(state.errorBucket);
  if(items.every(([k,v])=>v===0)){ et.innerHTML = `<div class="tiny">目前沒有明顯的常錯型態。</div>`; }
  else{
    for(const [k,v] of items){
      const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;border-radius:10px;padding:6px 10px';
      row.innerHTML = `<div>${k}</div><div class="tiny">錯 <b>${v}</b> 次</div>`; et.appendChild(row);
    }
  }
  const log = $('#recentLog'); log.innerHTML=''; const last = state.history.slice(-10).reverse();
  if(last.length===0){ log.innerHTML = `<div class="tiny">尚無資料</div>`; }
  else{
    last.forEach(r=>{
      const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;border-radius:10px;padding:6px 10px';
      const ans = r.sign==='+'? r.a+r.b : r.a-r.b;
      row.innerHTML = `<div>${r.a} ${r.sign} ${r.b} = ${ans}</div><div class="${r.correct?'ok':'ng'}">${r.correct?'✔︎':'✖︎'}</div>`;
      log.appendChild(row);
    });
  }
}

/* ===== 設定面板 ===== */
const modal = $('#settingsModal');
$('#btnSettings').addEventListener('click', ()=>{
  $('#minVal').value=state.settings.minVal; $('#maxVal').value=state.settings.maxVal;
  $('#soundOn').checked=state.settings.soundOn; $('#autoExam').checked=state.settings.autoExam; $('#showNumlinePractice').checked=state.settings.showNumlinePractice;
  $('#nickname').value=state.user.nickname||'';
  modal.classList.remove('hidden');
});
$('#btnCloseSettings').addEventListener('click', ()=> modal.classList.add('hidden'));
$('#btnReset').addEventListener('click', ()=>{
  if(confirm('確定清除本機學習資料嗎？')){ localStorage.removeItem(LS_KEY); location.reload(); }
});
$('#minVal').addEventListener('change', e=>{ state.settings.minVal=Number(e.target.value); save(); setProblem({a:state.a, sign:state.sign, b:state.b}); });
$('#maxVal').addEventListener('change', e=>{ state.settings.maxVal=Number(e.target.value); save(); setProblem({a:state.a, sign:state.sign, b:state.b}); });
$('#soundOn').addEventListener('change', e=>{ state.settings.soundOn=!!e.target.checked; save(); });
$('#autoExam').addEventListener('change', e=>{ state.settings.autoExam=!!e.target.checked; save(); });
$('#showNumlinePractice').addEventListener('change', e=>{ state.settings.showNumlinePractice=!!e.target.checked; save(); setProblem({a:state.a, sign:state.sign, b:state.b}); });
$('#nickname').addEventListener('change', e=>{ state.user.nickname=e.target.value.trim(); save(); });

/* ===== 事件：送出／下一題／略過（行動版可靠觸發） ===== */
const submitAnswerPointerSafe = ()=> submitAnswer();
elSubmit.addEventListener('click', submitAnswerPointerSafe);
elSubmit.addEventListener('pointerup', submitAnswerPointerSafe);
elNext.addEventListener('click', ()=> nextProblem());
elNext.addEventListener('pointerup', ()=> nextProblem());
elSkip.addEventListener('click', ()=> skipQuestion());
elSkip.addEventListener('pointerup', ()=> skipQuestion());

// 手機負號鍵
$('#btnMinus').addEventListener('click', ()=>{
  const v = elAns.value;
  if(v.startsWith('-')){ elAns.value = v.slice(1); }
  else{ elAns.value = v ? ('-'+v) : '-'; }
  elAns.focus({preventScroll:true});
});
$('#btnClear').addEventListener('click', ()=>{ elAns.value=''; elAns.focus({preventScroll:true}); });

// Enter 送出
elAns.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submitAnswer(); });

$$('.mode-tabs button').forEach(btn=> btn.addEventListener('click', ()=> switchMode(btn.dataset.mode)));

/* ===== 初始化 ===== */
function init(){ load(); updateHeader(); renderRightPanels(); nextProblem(); document.addEventListener('gesturestart', e=>e.preventDefault()); }
init();
</script>
</body>
</html>
